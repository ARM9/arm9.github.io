let Body,Key,Planet,Sector,Universe,Vec2,main;function loadImage(url,w,h){let img;if(w===undefined||h===undefined){img=new Image}else{img=new Image(w,h)}img.src=url;return img}let maro=loadImage("assets/mario-walk.png"),bg=loadImage("assets/bg.png"),erf=loadImage("assets/erf.png"),moonpic=loadImage("assets/moon.png"),lava=loadImage("assets/lava.png"),kepler=loadImage("assets/kepler438b.png");function randomColor(rc=1,gc=1,bc=1){let r=Math.random()*rc,g=Math.random()*gc,b=Math.random()*bc;return`rgb(${r}, ${g}, ${b})`}function randomInRange(min,max){return Math.random()*(max-min)+min}function randomHexColorInRange(min,max){let color=randomInRange(min,max)|0;return"#"+color.toString(16)}Key={_pressed:{},LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",isDown:function(kc){return this._pressed[kc]},onKeydown:function(e){this._pressed[e.key]=true},onKeyup:function(e){this._pressed[e.key]=false},isDownMulti:function(ks){return ks.every(k=>this._pressed[k])}};window.addEventListener("keyup",function(e){Key.onKeyup(e)},false);window.addEventListener("keydown",function(e){Key.onKeydown(e)},false);class Circle{draw(ctx){ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.closePath();ctx.fill()}}Planet=class Planet extends Circle{constructor({x:x,y:y,radius:radius,density:density,friction:friction,color:color,sprite:sprite}){super();this.x=x;this.y=y;this.radius=radius;this.density=density;this.friction=friction;this.color=color||randomColor();this.sprite=sprite||undefined;this.gravity=this.density/1e3}gravityField(){return this.gravity*2800}draw(ctx){if(this.sprite){let ox=this.x-this.radius,oy=this.y-this.radius;ctx.save();ctx.translate(-this.radius,-this.radius);ctx.drawImage(this.sprite,this.x,this.y,this.radius*2,this.radius*2);ctx.restore()}else{Circle.prototype.draw.call(this,ctx)}}drawGravityField(ctx){ctx.strokeStyle="red";ctx.beginPath();ctx.arc(this.x,this.y,Math.sqrt(this.gravityField()),0,Math.PI*2);ctx.closePath();ctx.stroke()}};Body=function(){class Body{constructor(x1,y1,radius,color1="#ffffff"){this.x=x1;this.y=y1;this.radius=radius;this.facing=1;this.color=color1}setPlanet(planet1){this.planet=planet1}draw(ctx){let rot=this.down-Math.PI/2;ctx.save();ctx.translate(this.x,this.y);ctx.rotate(rot);ctx.scale(this.facing|0,1);ctx.drawImage(maro,0,0,16,32,-8,-16,16,32);ctx.restore()}step(dt){let dist,dr,dx,dx_normal,dy,dy_normal,gx,gy,norm_dist,ref,ref1,vv_dot_n;gx=gy=0;dr=0;if(this.planet!==null){dx=this.planet.x-this.x;dy=this.planet.y-this.y;dist=Vec2.dot(dx,dy);this.down=Math.atan2(dy,dx);gx=dx/dist*this.planet.gravity;gy=dy/dist*this.planet.gravity;this.vx+=gx;this.vy+=gy;dr=this.planet.radius+this.radius;if(dist<=dr*dr){norm_dist=Math.sqrt(dist);dx_normal=dx/norm_dist;dy_normal=dy/norm_dist;vv_dot_n=this.vx*dx_normal+this.vy*dy_normal;this.vx=this.planet.friction*(-2*vv_dot_n*dx_normal+this.vx);this.vy=this.planet.friction*(-2*vv_dot_n*dy_normal+this.vy);if(-1<(ref=this.vx)&&ref<1&&(-1<(ref1=this.vy)&&ref1<1)){this.stick=true}if(this.stick){this.vx=0;this.vy=0}}}let vx=Math.sin(this.down)*(this.stick?.9:.021),vy=-Math.cos(this.down)*(this.stick?.9:.021);if(Key.isDown(Key.LEFT)){this.vx-=vx;this.vy-=vy;this.facing=-1}else if(Key.isDown(Key.RIGHT)){this.vx+=vx;this.vy+=vy;this.facing=1}if(Key.isDown(Key.UP)){if(this.stick){this.vx-=dx_normal*3.3;this.vy-=dy_normal*3.3;this.stick=false}}this.x+=this.vx;this.y+=this.vy}}Body.prototype.planet=null;Body.prototype.down=0;Body.prototype.vx=0;Body.prototype.vy=0;Body.prototype.stick=false;return Body}.call(this);Universe=function(){class Universe{constructor(sectors){let e,j,len;if(sectors!=null){for(j=0,len=sectors.length;j<len;j++){e=sectors[j];this.sectors.push(e)}}}addChild(c){let e,j,len;if(c instanceof Sector){this.sectors.push(c)}else if(c instanceof Array){for(j=0,len=c.length;j<len;j++){e=c[j];this.addChild(e)}}else{throw new Error(`Can't add ${typeof c} ${c} to Universe ${this}`)}}step(dt){}draw(ctx){let j,len,ref,s;ref=this.sectors;for(j=0,len=ref.length;j<len;j++){s=ref[j];s.draw(ctx)}}}Universe.prototype.sectors=[];return Universe}.call(this);Sector=class Sector{constructor(x1,y1,side=512,planets=[],bodies=[]){this.x=x1;this.y=y1;this.side=side;this.planets=planets;this.bodies=bodies}addChild(c){let e,j,len;if(c instanceof Planet){this.planets.push(c)}else if(c instanceof Body){this.bodies.push(c)}else if(c instanceof Array){for(j=0,len=c.length;j<len;j++){e=c[j];this.addChild(e)}}else{throw new Error(`Can't add ${typeof c} ${c} to Sector ${this}`)}}draw(ctx){let b,j,k,len,len1,p,ref,ref1;ref=this.planets;for(j=0,len=ref.length;j<len;j++){p=ref[j];p.draw(ctx)}ref1=this.bodies;for(k=0,len1=ref1.length;k<len1;k++){b=ref1[k];b.draw(ctx)}}step(dt){let body,dr,j,k,len,len1,planet,ref,ref1;ref=this.bodies;for(j=0,len=ref.length;j<len;j++){body=ref[j];ref1=this.planets;for(k=0,len1=ref1.length;k<len1;k++){planet=ref1[k];dr=Vec2.dot(body.x-planet.x,body.y-planet.y);if(Math.abs(dr)<=planet.gravityField()){body.setPlanet(planet)}}body.step(dt)}}};Vec2=class Vec2{static dot(x,y){return x*x+y*y}};let earth,moon,moon2,turboSteps;main=function(){let canvas,color,ctx,i,j,r,scene,sector0,step,time_prev,x,y;let windowSize=[document.documentElement.clientWidth,document.documentElement.clientHeight];canvas=document.createElement("canvas");canvas.width=windowSize[0];canvas.height=windowSize[1];canvas.style=`background: url('assets/bg.png') repeat; position: absolute; width: 100%,height: 100%;`;document.body.appendChild(canvas);ctx=canvas.getContext("2d");earth=new Planet({x:windowSize[0]/2+-170,y:windowSize[1]/2+70,radius:90,density:1e4,friction:.3,color:"#207ff2",sprite:erf});moon=new Planet({x:windowSize[0]/2+0,y:windowSize[1]/2+-160,radius:35,density:4800,friction:.8,color:"#cfcfef",sprite:moonpic});moon2=new Planet({x:windowSize[0]/2+130,y:windowSize[1]/2+120,radius:45,density:6e3,friction:.7,color:"#c48933",sprite:lava});kepler=new Planet({x:windowSize[0]/2+430,y:windowSize[1]/2+-80,radius:65,density:5e3,friction:.5,color:"#c48933",sprite:kepler});scene=new Universe;sector0=new Sector(0,0);sector0.addChild([earth,moon,moon2,kepler]);scene.addChild(sector0);for(i=j=1;j<=128;i=++j){x=windowSize[0]/2+Math.cos(i)*windowSize[0]/2;y=windowSize[1]/2+Math.sin(i)*windowSize[1]/2;let dude=new Body(x,y,16);dude.vx=-Math.cos(i)*3+Math.random()-.5;dude.vy=-Math.sin(i)*3+Math.random()-.5;dude.down=Math.atan2(dude.vy,dude.vx);let facing=Math.random();dude.facing=Math.random()>=.5?1:-1;sector0.addChild(dude)}turboSteps=10;time_prev=0;step=function(t){let dt=t-time_prev;time_prev=t;if(Key.isDown("t")){for(let i=0;i<turboSteps;i++){sector0.step(dt)}}sector0.step(dt);ctx.clearRect(0,0,canvas.width,canvas.height);scene.draw(ctx);window.requestAnimationFrame(step)};return step()};main();